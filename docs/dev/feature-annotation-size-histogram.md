# 機能: アノテーションサイズヒストグラム分析機能

## 概要

COCOフォーマットのアノテーションデータに対する詳細な統計分析機能を実装。ヒストグラム、ヒートマップ、統計情報の表示機能を追加し、データ探索と傾向把握を支援する包括的な分析ツールを提供。

## 実装期間

- ブランチ: `feature/annotation-size-histogram`
- ベースコミット: f53bc770cc476191b73922819fee408193ee15e0 (develop)
- コミット数: 6個の主要コミット
- 変更ファイル数: 40ファイル
- 追加行数: 4,475行、削除行数: 1,145行

## 主要機能

### 1. ヒストグラム分析機能

1次元の分布分析を提供し、アノテーションの特性を可視化。

#### 機能

- 5つの分布タイプ対応（幅、高さ、面積、ポリゴン面積、アスペクト比）
- ビン数調整（5-50個）
- 線形・対数スケール切り替え
- カテゴリ別フィルタリング
- 現在画像・全画像の表示切り替え
- 詳細統計情報表示（平均、中央値、標準偏差、歪度、尖度等）
- CSVデータのクリップボードコピー機能

#### 技術詳細

- **ライブラリ**: Recharts 2.15.3を使用したプロフェッショナルなチャート描画
- **状態管理**: Zustand（useHistogramStore）による独立した状態管理
- **計算処理**: ポリゴン面積の正確な計算（Shoelace公式）
- **パフォーマンス**: メモ化とUseMemoによる最適化

### 2. ヒートマップ分析機能

2次元の分布分析により、複数の変数間の関係性を可視化。

#### 機能

- 4つのヒートマップタイプ（幅×高さ、中心X×Y、面積×アスペクト比、ポリゴン面積×アスペクト比）
- X/Y軸のビン数独立調整（5-50個）
- 5つのカラースケール（Viridis、Plasma、Inferno、Magma、Cividis）
- カテゴリフィルタとビューモード切り替え
- 統計サマリー表示（総数、範囲情報）
- CSVエクスポート機能

#### 技術詳細

- **ライブラリ**: @nivo/heatmap 0.99.0による高品質なヒートマップ描画
- **データ処理**: 2次元ビン分割アルゴリズムの独自実装
- **ポリゴン処理**: Shoelace公式によるポリゴン面積計算
- **UI統合**: 統一されたモーダルデザインによる一貫したユーザー体験

### 3. 共通モーダルコンポーネント

統計機能に共通のモーダルインターフェースを提供。

#### 機能

- 統一されたモーダルデザイン
- ブラー背景効果
- レスポンシブサイズ対応（sm, md, lg, xl）
- アクセシビリティ対応（ESCキー、オーバーレイクリック）

#### 改善点

- 従来の個別モーダル実装を統一
- 一貫したユーザー体験の提供
- メンテナンス性の向上

### 4. メニュー統合とキーボードショートカット

統計機能への簡単なアクセスを提供。

#### 機能

- Tauriメニューシステムとの統合
- ヒストグラム: Cmd/Ctrl+Shift+H
- ヒートマップ: Cmd/Ctrl+Shift+M
- 統計ダイアログ: Cmd/Ctrl+I（既存）

#### 技術詳細

- **Rustメニュー**: src-tauri/src/menu.rsでのメニュー項目追加
- **イベント処理**: useMenuEventsフックでのイベントリスナー統合
- **権限設定**: Tauriケイパビリティでのメニューアクセス許可

## ファイル変更

### 新規ファイル

#### コンポーネント
- `src/components/CommonModal/` - 共通モーダルコンポーネント
- `src/components/HistogramChart/` - ヒストグラムチャートコンポーネント
- `src/components/HistogramPanel/` - ヒストグラムパネルコンポーネント
- `src/components/HeatmapChart/` - ヒートマップチャートコンポーネント
- `src/components/HeatmapPanel/` - ヒートマップパネルコンポーネント
- `src/components/HeatmapDialog/` - ヒートマップダイアログコンポーネント

#### 状態管理
- `src/stores/useHistogramStore.ts` - ヒストグラム専用状態管理
- `src/stores/useHeatmapStore.ts` - ヒートマップ専用状態管理

#### ユーティリティ
- `src/utils/histogram.ts` - ヒストグラム計算ロジック
- `src/utils/heatmap.ts` - ヒートマップ計算ロジック

### 変更されたファイル

主な変更は以下のファイルに加えられました:

- `src/App.tsx` - 新しいダイアログ統合とメニューイベント処理
- `src/hooks/useMenuEvents.ts` - ヒストグラム・ヒートマップメニューイベント追加
- `src/components/ControlPanel/ControlPanel.tsx` - ヒストグラムボタンの追加
- `src-tauri/src/menu.rs` - Rustメニューシステムでの新項目追加
- `src/i18n/locales/*.json` - 多言語対応（日本語・英語）
- `README.md`, `README.en.md` - 統計情報の免責事項追加

## バグ修正

1. **統計ダイアログの適切な統合**
   - 既存の統計ダイアログを新しいCommonModalコンポーネントに移行し、一貫性を向上

2. **ポリゴン面積計算の正確性**
   - Shoelace公式を使用したポリゴン面積計算の実装により、セグメンテーションデータの正確な分析を実現

3. **CSVエクスポートの信頼性**
   - ブラウザのポップアップブロッカーの影響を回避するため、クリップボードAPIとフォールバック機能を実装

## テスト方法

この機能は以下の方法でテストできます:

1. **ヒストグラム機能**: Cmd/Ctrl+Shift+Hで起動、分布タイプとビン数を変更してグラフの動的更新を確認
2. **ヒートマップ機能**: Cmd/Ctrl+Shift+Mで起動、ヒートマップタイプとカラースケールの変更を確認
3. **共通機能**: カテゴリフィルタ、ビューモード切り替え、統計情報表示の動作確認
4. **データエクスポート**: クリップボードコピー機能の動作確認
5. **レスポンシブ**: 異なる画面サイズでのUI動作確認

## 今後の改善点

1. **テスト環境の構築**: ユニットテスト・E2Eテストの実装
2. **パフォーマンス最適化**: 大規模データセット（10万アノテーション以上）での処理速度向上
3. **追加統計指標**: より高度な統計分析（相関分析、クラスタリング等）の実装
4. **エクスポート機能拡張**: PDF、PNG形式でのチャートエクスポート
5. **カスタマイズ性向上**: ユーザー定義の統計指標やチャート設定の保存機能

## 依存関係

新しい外部依存関係:

- **@nivo/core@0.99.0** - 高品質なデータ可視化コンポーネントの基盤
- **@nivo/heatmap@0.99.0** - ヒートマップ専用コンポーネント
- **recharts@2.15.3** - React用チャートライブラリ（ヒストグラム用）

既存ライブラリを活用:
- **React 18** - UI基盤
- **Zustand** - 状態管理
- **i18next** - 国際化
- **Tauri 2.0** - デスクトップアプリケーション基盤

## 免責事項

統計機能について、データ探索目的の参考値である旨と開発者の責任制限をREADMEに明記。学術研究や商用利用時の適切な検証の重要性を強調。