# 機能: feature/multi-image-navigation

## 概要

複数画像間のナビゲーション機能を実装し、フォルダ内の画像を簡単に切り替えられるようにしました。また、比較モード中でも画像間を移動でき、各画像に対応するペアアノテーションが動的に更新されます。

## 実装期間

- ブランチ: `feature/multi-image-navigation`
- バージョン: v1.1.0（予定）
- コミット数: 約4

## 主要機能

### 1. NavigationPanel コンポーネント

新しいナビゲーションパネルを実装し、フォルダ内の画像間を移動できるようにしました。

#### 機能

- 前へ/次へボタンによる画像切り替え
- IDジャンプ機能（画像IDを直接入力して移動）
- 存在しない画像のスキップ機能
- フォルダモードと単一画像モードの切り替え
- 画像切り替え時のズーム/パン状態の保持

#### 技術詳細

- **状態管理**: Zustand を使用した `useNavigationStore` で画像リストと現在のインデックスを管理
- **非同期処理**: Tauri の `scan_folder` コマンドで画像ファイルを効率的にスキャン
- **パフォーマンス**: 画像切り替え時の `preserveViewState` フラグで不要な再レンダリングを防止
- **アクセシビリティ**: キーボードショートカット（矢印キー）による操作をサポート

### 2. 比較モードの拡張

比較モード中でも画像間のナビゲーションが可能になり、各画像に対応するペアアノテーションが動的に更新されます。

#### 機能

- フォルダモードでは自動的に対応する画像IDのアノテーションを使用
- 画像切り替え時にペアアノテーションを動的に更新
- 対応するアノテーションがない画像では情報メッセージを表示
- 比較設定変更時も全画像のアノテーションを保持

#### 改善点

- 元の比較データ（`originalComparisonData`）を保持することで、画像切り替え時の再フィルタリングが可能に
- 比較モード中でもナビゲーション機能が使えるため、複数画像の比較が効率的に

### 3. UI/UX の改善

ナビゲーション関連のUIを改善し、より直感的な操作を実現しました。

#### 機能

- ナビゲーションパネルの独立したタブ化
- 画像切り替え時のローディングインジケーター
- 画像存在確認とエラーハンドリング
- レスポンシブデザイン対応

#### 改善点

- モバイルビューでのナビゲーションパネルの最適化
- 画像切り替え時の選択アノテーションのクリア
- パネル設定での重複表示の解消

## ファイル変更

### 新規ファイル

- `src/components/NavigationPanel/NavigationPanel.tsx` - ナビゲーションパネルのメインコンポーネント
- `src/components/NavigationPanel/NavigationPanel.css` - ナビゲーションパネルのスタイル定義
- `src/components/NavigationPanel/index.tsx` - エクスポート用インデックス
- `src/stores/useNavigationStore.ts` - ナビゲーション状態管理ストア

### 変更されたファイル

主な変更は以下のファイルに加えられました:

- `src-tauri/src/commands/mod.rs` - `scan_folder` コマンドの追加（画像ファイルスキャン機能）
- `src/App.tsx` - NavigationPanel の統合とタブ構造の更新
- `src/components/ComparisonDialog/ComparisonDialog.tsx` - ナビゲーションモード対応と元データ保持機能
- `src/stores/useAnnotationStore.ts` - `originalComparisonData` の追加と `updateComparisonForCurrentImage` の実装
- `src/stores/useImageStore.ts` - `preserveViewState` フラグの追加
- `src/components/ImageViewer/ImageViewer.tsx` - 画像切り替え時のビュー状態保持機能
- `src/i18n/locales/*.json` - ナビゲーション関連の翻訳文字列追加

## バグ修正

1. **ReferenceError の修正**
   - 関数定義の順序を修正し、NavigationPanel の初期化エラーを解決

2. **画像ID リセット問題**
   - タブ切り替え時の不要な画像ID リセットを防止

3. **ズーム/パン状態のリセット**
   - 画像切り替え時に `preserveViewState` フラグを使用してビュー状態を保持

4. **比較モードでのデータ損失**
   - 元データを保持することで、設定変更時のアノテーション損失を防止

5. **重複タブ表示**
   - パネル設定での Info タブの重複を解消

## テスト方法

この機能は以下の方法でテストできます:

1. フォルダを開いて複数の画像を含むアノテーションファイルを読み込む
2. ナビゲーションタブで矢印ボタンまたはキーボードの矢印キーで画像を切り替える
3. IDジャンプ機能で特定の画像IDに直接移動する
4. 比較モードを開始し、画像を切り替えてペアアノテーションが更新されることを確認
5. 比較設定を変更後、他の画像に移動してもアノテーションが表示されることを確認

## 今後の改善点

1. サムネイルのキャッシュ機能の実装
2. 画像のプリロード機能による切り替えの高速化
3. フィルタリング機能（カテゴリや画像サイズでの絞り込み）
4. 画像グリッドビューの追加
5. キーボードショートカットのカスタマイズ機能

## 依存関係

新しい外部依存関係は追加されていません。既存のライブラリを使用:

- Zustand（状態管理）
- React（UIコンポーネント）
- Tauri API（ファイルシステムアクセス）
- i18next（国際化対応）