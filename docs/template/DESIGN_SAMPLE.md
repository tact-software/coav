# アノテーションサイズ分布ヒストグラム - 詳細設計書

## 1. 概要

### 1.1 目的

データセット内のオブジェクトサイズの分布を視覚的に理解し、モデル設計とデータ拡張戦略の最適化を支援する。

### 1.2 背景・現状の課題

- アノテーションサイズ分布を確認するには外部ツール（Python、Excel等）へのエクスポートが必要
- データセットの不均衡（小さい/大きいオブジェクトの偏り）の把握が困難
- カテゴリ別のサイズ分布比較ができない
- リアルタイムでのインタラクティブな分析が不可能

### 1.3 スコープ

**対象範囲**:
- バウンディングボックスのサイズ分布可視化
- カテゴリ別比較機能
- インタラクティブなフィルタリング
- 統計情報の表示とエクスポート

**対象外**:
- セグメンテーションマスクの面積計算
- 3D アノテーションのサイズ分析
- 時系列でのサイズ変化追跡

### 1.4 優先度

Medium - Nice to have

## 2. ユーザーストーリー

### 2.1 想定ユーザー

- データサイエンティスト
- 機械学習エンジニア
- データアノテーター/キュレーター

### 2.2 ユースケース

- **シナリオ1**: データセットの品質評価
  - ユーザーは新しいデータセットを受け取った
  - オブジェクトサイズの分布を確認して、モデル設計の参考にしたい
  - 小さすぎる/大きすぎるオブジェクトの割合を把握したい

- **シナリオ2**: データ拡張戦略の決定
  - 特定のサイズ範囲のオブジェクトが少ないことを発見
  - 該当するアノテーションを特定して、重点的に拡張したい

- **シナリオ3**: カテゴリ間の比較分析
  - カテゴリごとのサイズ特性を比較
  - 特定カテゴリのサイズ異常を検出

## 3. 機能要件

### 3.1 必須要件

- **ヒストグラム表示**
  - 幅、高さ、面積、アスペクト比の4種類の分布
  - ビン数の自動/手動設定（5〜100）
  - リニア/ログスケールの切り替え

- **インタラクティブ機能**
  - ホバーでの詳細情報表示（ビン範囲、カウント、割合）
  - クリックで該当アノテーションをハイライト

- **カテゴリ管理**
  - カテゴリ別の色分け表示
  - 特定カテゴリの表示/非表示切り替え

### 3.2 オプション要件

- **高度なフィルタリング**
  - 複数の条件を組み合わせたフィルタリング
  - フィルタ条件の保存/読み込み

- **比較モード**
  - 複数データセットの分布比較
  - 時系列での変化追跡

### 3.3 非機能要件

- **パフォーマンス**: 10,000アノテーションで初期描画3秒以内
- **スケーラビリティ**: 100,000アノテーションまで対応
- **ユーザビリティ**: 3クリック以内で主要機能にアクセス
- **アクセシビリティ**: WCAG 2.1 AA準拠

## 4. UI/UX設計

### 4.1 画面構成

```text
┌─────────────────────────────────────────────┐
│ アノテーションサイズ分布                     │
├─────────────────────────────────────────────┤
│ [分布タイプ▼] [ビン数: 20 ▼] [スケール▼]  │
│ [エクスポート]                              │
├─────────────────────────────────────────────┤
│                                             │
│    ▁▂▃▄▅▆▇█▇▆▅▄▃▂▁                       │
│    ヒストグラム表示エリア                    │
│                                             │
├─────────────────────────────────────────────┤
│ カテゴリフィルタ:                          │
│ ☑ 全て ☐ person ☐ car ☐ bicycle ...       │
├─────────────────────────────────────────────┤
│ サイズ範囲: [====|========|====]           │
│            Min: 50px   Max: 500px          │
├─────────────────────────────────────────────┤
│ 統計情報:                                  │
│ 平均: 234px | 中央値: 180px | σ: 89px     │
│ 最小: 10px  | 最大: 1200px                 │
└─────────────────────────────────────────────┘
```

### 4.2 インタラクション

- **ホバー時**: ツールチップで詳細表示
- **クリック時**: 対応するアノテーションを画像ビューアでハイライト
- **ドラッグ時**: 範囲選択してズーム
- **右クリック**: コンテキストメニュー（エクスポート、リセット等）

### 4.3 レスポンシブ対応

- **デスクトップ** (1200px+): フル機能
- **タブレット** (768-1199px): サイドパネル折りたたみ
- **モバイル** (< 768px): 縦スクロール、簡略表示

## 5. 技術設計

### 5.1 アーキテクチャ

```text
┌─────────────────┐     ┌─────────────────┐
│  HistogramPanel │────▶│ useHistogramStore│
└─────────────────┘     └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│ HistogramChart  │     │ HistogramUtils  │
└─────────────────┘     └─────────────────┘
```

### 5.2 データモデル

```typescript
interface HistogramBin {
  range: [number, number];
  count: number;
  categoryBreakdown: Map<number, number>;
  annotationIds: number[];
}

interface HistogramData {
  type: 'width' | 'height' | 'area' | 'aspectRatio';
  bins: HistogramBin[];
  statistics: HistogramStatistics;
}

interface HistogramStatistics {
  mean: number;
  median: number;
  std: number;
  min: number;
  max: number;
  q1: number;
  q3: number;
  total: number;
}

interface HistogramSettings {
  binCount: number;
  scale: 'linear' | 'log';
  selectedCategories: Set<number>;
  sizeRange: [number, number] | null;
}
```

### 5.3 API設計

内部APIのみ（Tauriコマンドは不要）

### 5.4 状態管理

```typescript
interface HistogramStore {
  // 設定
  settings: HistogramSettings;
  
  // 計算結果
  histogramData: HistogramData | null;
  highlightedAnnotations: Set<number>;
  
  // アクション
  setHistogramType: (type: HistogramType) => void;
  setBinCount: (count: number) => void;
  setScale: (scale: 'linear' | 'log') => void;
  toggleCategory: (categoryId: number) => void;
  setSizeRange: (range: [number, number] | null) => void;
  highlightBin: (binIndex: number) => void;
  exportData: (format: 'csv' | 'json') => void;
}
```

### 5.5 使用技術・ライブラリ

| ライブラリ | 用途 | 選定理由 |
|-----------|------|----------|
| Recharts | チャート描画 | React対応、軽量、カスタマイズ性高 |
| d3-scale | スケール計算 | 業界標準、ログスケール対応 |
| simple-statistics | 統計計算 | 軽量、必要十分な機能 |

## 6. 実装計画

### 6.1 フェーズ分け

- **フェーズ1**: 基本機能（2週間）
  - [x] ヒストグラムコンポーネントの作成
  - [x] 基本的な分布タイプ（幅、高さ、面積）の実装
  - [x] Rechartsの統合
  - [ ] 統計値計算ロジック

- **フェーズ2**: インタラクティブ機能（1週間）
  - [ ] ホバーツールチップ
  - [ ] クリックでアノテーションハイライト
  - [ ] カテゴリ別表示切替

- **フェーズ3**: フィルタリング（1週間）
  - [ ] サイズ範囲スライダー
  - [ ] フィルタ適用ロジック
  - [ ] UIフィードバック

- **フェーズ4**: エクスポート（3日）
  - [ ] CSVエクスポート
  - [ ] 画像エクスポート

- **フェーズ5**: 最適化・テスト（3日）
  - [ ] パフォーマンステスト
  - [ ] UIレスポンシブ対応
  - [ ] ドキュメント作成

### 6.2 マイルストーン

- M1: 基本的なヒストグラム表示（2週間後）
- M2: インタラクティブ機能完成（3週間後）
- M3: 全機能実装完了（4週間後）
- M4: リリース準備完了（5週間後）

## 7. テスト計画

### 7.1 ユニットテスト

- ヒストグラム計算関数
- 統計値計算関数
- ビン分割ロジック
- フィルタリング処理

### 7.2 統合テスト

- Zustandストアとの連携
- 大規模データセット（10,000+ アノテーション）
- カテゴリ切替時の再計算

### 7.3 E2Eテスト

- ユーザーシナリオ1: 初回表示からエクスポートまで
- ユーザーシナリオ2: フィルタリングと分析
- ユーザーシナリオ3: カテゴリ比較

### 7.4 パフォーマンステスト

- 100,000アノテーションでの描画時間
- メモリ使用量の監視
- 再計算時のレスポンス

## 8. リスクと対策

### 8.1 技術的リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|---------|----------|------|
| 大規模データでの描画遅延 | 高 | 中 | 仮想化、Web Worker使用 |
| メモリ不足 | 高 | 低 | 段階的データ読み込み |
| ライブラリ依存 | 中 | 低 | 動的インポート |

### 8.2 スケジュールリスク

- Rechartsのカスタマイズが想定より複雑 → D3.jsへの切り替えも検討
- パフォーマンス要件未達 → 機能を段階的にリリース

## 9. セキュリティ考慮事項

### 9.1 データ保護

- ローカル処理のみ（データ送信なし）
- エクスポート時のファイル権限確認

### 9.2 アクセス制御

- 読み取り専用操作のみ
- ファイルシステムへの書き込みは明示的な操作時のみ

## 10. 国際化（i18n）対応

### 10.1 翻訳対象

- UIラベル（分布タイプ、統計情報等）
- ツールチップメッセージ
- エラーメッセージ

### 10.2 ローカライゼーション

- 数値フォーマット（小数点、千位区切り）
- 単位表示（px、%）

## 11. ドキュメント計画

### 11.1 ユーザードキュメント

- 機能概要と使い方
- ヒストグラムの読み方ガイド
- FAQ

### 11.2 開発者ドキュメント

- コンポーネントAPI
- カスタマイズ方法
- パフォーマンスチューニング

## 12. 関連情報

### 12.1 参考資料

- [Recharts Documentation](https://recharts.org/)
- [D3.js Histogram Example](https://d3js.org/d3-array/bin)
- [Simple Statistics](https://simplestatistics.org/)

### 12.2 関連Issue/PR

- Issue #6: [FEATURE] アノテーションサイズ分布ヒストグラム

## 13. 承認・レビュー

### 13.1 レビュアー

- [ ] 技術リード: @tact-software
- [ ] UIデザイナー: TBD
- [ ] プロダクトオーナー: TBD

### 13.2 承認履歴

| 日付 | レビュアー | ステータス | コメント |
|------|-----------|-----------|----------|
| 2025-05-29 | - | ドラフト | 初版作成 |

---

**注意事項**:
- この設計書は Issue #6 のサンプル実装例です
- 実際の実装時には、チームでのレビューと調整が必要です
- パフォーマンス要件は実際のユーザー環境に応じて調整してください