# 機能: 正解データ差分可視化

## 概要

この機能は、COAV (COCO Annotation Viewer) に比較モード機能を追加し、2つのCOCOデータセット（例：正解データと予測結果）の視覚的な比較と評価指標の算出を可能にします。

## 実装期間

- ブランチ: `feature/ground-truth-diff-visualization`
- バージョン: v1.x.x
- コミット数: 5つの主要コミット

## 主要機能

### 1. 比較モード

2つのCOCO形式のデータセットを並べて視覚的に比較できる新しいモードです。

#### 機能

- 2つのCOCO JSONファイルの読み込みと比較
- TP（真陽性）、FP（偽陽性）、FN（偽陰性）アノテーションの視覚的な区別
- IoUベースのマッチングアルゴリズム
- データセット間で異なる画像IDのサポート
- カテゴリマッピング機能

#### 技術詳細

- **マッチングアルゴリズム**: IoU閾値を使用したグリーディアルゴリズム
- **IoU計算方法**:
  - バウンディングボックスIoU: 正確な面積計算
  - ポリゴンIoU: グリッドベースの近似（100x100グリッド）
- **複数マッチングサポート**: アノテーションごとの最大マッチ数を設定可能（1からN）
- **役割の割り当て**: 読み込んだファイルに対してGT/Predの役割を柔軟に割り当て

### 2. カテゴリマッピング

2つのデータセット間で異なるカテゴリ体系をマッピングできます。

#### 機能

- カテゴリ名による自動マッピング
- ドラッグ&ドロップスタイルの手動マッピングUI
- 1対多のカテゴリマッピングサポート
- マッピング済み/未マッピングカテゴリの視覚的表示

#### 改善点

- useEffectの無限ループを修正
- マッピングでのカテゴリ再利用を許可
- 未使用カテゴリの表示を改善

### 3. 評価指標

物体検出の評価指標をリアルタイムで計算・表示します。

#### 算出される指標

- 真陽性（TP）
- 偽陽性（FP）
- 偽陰性（FN）
- Precision = TP / (TP + FP)
- Recall = TP / (TP + FN)
- F1スコア = 2 * (Precision * Recall) / (Precision + Recall)

#### 表示場所

- 統計ダイアログ
- アノテーション詳細パネル（比較されたアノテーション選択時）

### 4. 視覚的な強化

#### カラーコーディング

- 正解データ: TP/FNは緑色系
- 予測結果: TP/FPは青/赤色系
- 設定で色をカスタマイズ可能

#### UI改善

- 長時間処理用のローディングオーバーレイ
- 比較中の進捗表示
- ズームボタンがビューポート中心を基準にズーム
- 統計での単一画像データセットサポート

### 5. サンプルデータ生成の強化

比較モードのテスト用にペアデータセットを作成できるようサンプルデータジェネレータを強化しました。

#### 新しいオプション

- 設定可能なマッチ分布でペアJSONを生成
- カテゴリ名の変更（名前に"2"を追加）
- 以下の比率を設定可能:
  - 完全一致
  - 部分一致
  - 不一致（FN）
  - 追加オブジェクト（FP）

## ファイル変更

### 新規ファイル

- `src/components/ComparisonDialog/` - 比較設定UI
- `src/components/LoadingOverlay/` - グローバルローディングインジケータ
- `src/types/diff.ts` - 比較用のTypeScript型定義
- `src/utils/diff.ts` - コア比較ロジック
- `src/stores/useLoadingStore.ts` - ローディング状態管理
- `docs/COMPARISON_MODE_EVALUATION.md` - 詳細ドキュメント

### 変更されたファイル

主な変更は以下のファイルに加えられました:

- `useAnnotationStore.ts` - 比較状態管理を追加
- `ImageViewer.tsx` - ズーム機能の改善
- `AnnotationLayer.tsx` - TP/FP/FNの可視化
- `StatisticsDialog.tsx` - 評価指標の表示
- `sample_generator.rs` - ペアデータ生成

## バグ修正

1. **カテゴリマッピングリセット問題**
   - マッピングリセットを引き起こすuseEffectの無限ループを修正
   - 自動初期化を防ぐための手動マッピングフラグを追加

2. **カテゴリ再利用の制限**
   - 同じカテゴリを複数回使用する制限を削除
   - 未使用カテゴリの表示ロジックを改善

3. **単一画像データセットサポート**
   - 単一画像データセットで比較指標が表示されない問題を修正
   - 単一画像データの場合、ビューモードを自動的に'current'に設定

4. **ズーム動作**
   - ズームボタンがビューポート中心を基準にズームするよう修正

## テスト方法

この機能は以下の方法でテストできます:

1. ペアJSONオプション付きのサンプルデータジェネレータ
2. 実際の正解データと予測データセット
3. 異なるカテゴリ命名スキーム

## 今後の改善点

1. 比較結果のエクスポート
2. 比較履歴/セッション
3. より正確なポリゴンIoU計算
4. 複数画像のバッチ比較
5. 追加の評価指標（mAPなど）

## 依存関係

新しい外部依存関係は追加されていません。既存のライブラリを使用:

- React + TypeScript
- Zustand（状態管理）
- Konva.js（可視化）
- Tauri（バックエンド操作）