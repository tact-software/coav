# 比較モード評価方法の詳細仕様

## 概要

COAVの比較モードは、2つのCOCOフォーマットのアノテーションデータセットを比較し、物体検出の性能評価を行います。本ドキュメントでは、評価に使用される各種アルゴリズムと計算方法について詳細に説明します。

## IoU（Intersection over Union）の計算方法

### 1. バウンディングボックスIoU

バウンディングボックス形式のアノテーションに対しては、標準的なIoU計算を実装しています：

```
IoU = 交差面積 / 結合面積
```

具体的な計算手順：
1. 2つのバウンディングボックスの交差領域を計算
   - `intersectionX1 = max(box1.x1, box2.x1)`
   - `intersectionY1 = max(box1.y1, box2.y1)`
   - `intersectionX2 = min(box1.x2, box2.x2)`
   - `intersectionY2 = min(box1.y2, box2.y2)`
2. 交差面積を計算
   - 交差が存在しない場合（`x2 < x1` または `y2 < y1`）は0を返す
   - 存在する場合：`交差面積 = (x2 - x1) * (y2 - y1)`
3. 結合面積を計算
   - `結合面積 = box1の面積 + box2の面積 - 交差面積`
4. IoU = 交差面積 / 結合面積

### 2. ポリゴンIoU

セグメンテーション（ポリゴン）形式のアノテーションに対しては、グリッドベースの近似アルゴリズムを使用します：

1. **グリッド生成**
   - 両ポリゴンを包含するバウンディングボックスを計算
   - グリッドサイズを動的に決定：`gridSize = max(1, min(幅/50, 高さ/50))`
   - これにより、領域を約50×50のグリッドに分割（精度と性能のバランス）

2. **サンプリングポイント**
   - **ポイントはピクセルではなく、画像座標系上のサンプリング点**
   - グリッド間隔（gridSize）で等間隔にサンプリング
   - 例：200×200ピクセルの領域の場合、gridSize=4となり、4ピクセル間隔でサンプリング
   - 総サンプリング数は領域のサイズに依存（通常2,500点程度）

3. **ポイント内外判定（Ray Casting Algorithm）**
   - 各サンプリングポイントがポリゴン内にあるかを判定
   - 判定方法：ポイントから右方向に半直線を引き、ポリゴンの辺との交差回数をカウント
   - 交差回数が奇数：ポイントは内部
   - 交差回数が偶数：ポイントは外部

4. **IoU計算**
   - 両ポリゴンに含まれるサンプリングポイント数：交差ポイント数
   - いずれかのポリゴンに含まれるサンプリングポイント数：結合ポイント数
   - `IoU = 交差ポイント数 / 結合ポイント数`
   
**注意事項**：
- この手法は近似アルゴリズムであり、真のポリゴン面積ではない
- グリッドが細かいほど精度は向上するが、計算時間も増加
- 実装では性能を考慮し、適応的なグリッドサイズを使用

## TP/FP/FNの分類基準

### 基本的な分類ルール

1. **True Positive (TP)**
   - Ground Truth（GT）とPredictionの間でマッチングが成立したアノテーション
   - マッチング条件：`IoU ≥ 閾値`（デフォルト：0.5）
   - 同じカテゴリIDまたはカテゴリマッピングで対応付けられたカテゴリ

2. **False Positive (FP)**
   - Predictionデータセット内で、どのGTアノテーションともマッチしなかったアノテーション

3. **False Negative (FN)**
   - GTデータセット内で、どのPredictionともマッチしなかったアノテーション

### GT/Predictionの指定

- 設定で`gtFileId`を指定することで、どちらのファイルをGTとして扱うかを制御
- 未指定の場合は最初に読み込んだファイルがGT

## 最大マッチング数が2以上の場合の挙動

### アルゴリズムの詳細

`maxMatchesPerAnnotation > 1`の場合、1つのアノテーションが複数のアノテーションとマッチすることを許可します。これは、密集した物体や重なりのある場合に有用です。

**マッチングアルゴリズム（Greedy Assignment）**：

1. **全ペアのIoU計算**
   - GTとPredictionの全組み合わせに対してIoUを計算
   - カテゴリマッピングに従い、対応可能なカテゴリ間のみ計算

2. **IoUによるソート**
   - 計算された全マッチをIoUの降順でソート
   - 最も高いIoUを持つマッチから優先的に処理

3. **貪欲法による割り当て**
   ```
   for each match in sorted_matches:
     if (gt_match_count < maxMatches) AND (pred_match_count < maxMatches):
       assign match
       increment match counts
   ```

4. **結果の特性**
   - 各アノテーションは最大で`maxMatchesPerAnnotation`個のマッチを持つ
   - IoUが高いマッチが優先される
   - 一度マッチ数上限に達したアノテーションは、それ以上マッチしない

### 例：maxMatches=2の場合

```
GT: [A, B]
Pred: [1, 2, 3]
IoU値: A-1:0.8, A-2:0.7, A-3:0.6, B-1:0.75, B-2:0.65

処理順序（IoU降順）:
1. A-1 (0.8) → マッチ成立
2. B-1 (0.75) → マッチ成立
3. A-2 (0.7) → マッチ成立（Aの2個目）
4. B-2 (0.65) → マッチ成立（Bの2個目）
5. A-3 (0.6) → 却下（Aが既に上限）
```

## カテゴリマッピング機能

異なるカテゴリ体系を持つデータセット間の比較を可能にします：

- 1対多マッピングをサポート
- 例：`車両(id:1)` → `自動車(id:2), トラック(id:3), バス(id:4)`
- マッピングはUIから設定可能

## 統計情報の計算

### カテゴリ別統計
- **Precision** = TP / (TP + FP)
- **Recall** = TP / (TP + FN)
- **F1 Score** = 2 × (Precision × Recall) / (Precision + Recall)

### 全体統計
- 全カテゴリのTP、FP、FNを合計して計算

## 品質評価のための追加機能

### 1. 閾値未満マッチの追跡
- `0 < IoU < 閾値`のマッチも記録
- 閾値調整の参考情報として利用可能

### 2. 設定可能なパラメータ
- **IoU閾値**：0.0〜1.0（デフォルト：0.5）
- **最大マッチ数**：1〜10（デフォルト：1）
- **IoU計算方法**：bbox/polygon（デフォルト：bbox）

### 3. 視覚的フィードバック
- マッチしたアノテーションのハイライト表示
- IoU値の表示
- TP/FP/FN別の色分け表示

## 実装の参照先

詳細な実装は以下のファイルを参照：
- IoU計算ロジック：`src/utils/diffCalculator.ts`
- 比較設定管理：`src/stores/useAnnotationStore.ts`
- UI実装：`src/components/ImageViewer/ImageViewer.tsx`