# 実装計画

## 概要

アノテーションエディタ機能を段階的に実装する。
各フェーズは独立してテスト・リリース可能な単位で構成する。

## フェーズ構成

### Phase 1: 基盤整備

**目標**: プロジェクト管理の基本機能と、ビュー/アノテーションモードの切り替えを実装

#### 1.1 データモデル・型定義

- Project, ProjectSettings, ProjectCategory 型の定義
- EditableAnnotation 型の定義
- EditorTool, DrawingState 型の定義
- 既存 COCO 型との互換性確保

#### 1.2 バックエンドコマンド（基本）

- create_project コマンド
- load_project コマンド
- save_project コマンド
- save_annotations コマンド

#### 1.3 ストア実装

- useProjectStore（プロジェクト管理）
- useEditorStore（編集状態、ツール選択）
- useHistoryStore（Undo/Redo基盤）

#### 1.4 UI基盤

- モード切替UI（ヘッダー）
- プロジェクト作成ダイアログ
- プロジェクトを開くダイアログ
- カテゴリ管理ダイアログ（基本）

#### 1.5 国際化

- 新規翻訳キーの追加（ja.json, en.json）
- editor, project 関連の翻訳

---

### Phase 2: 描画機能

**目標**: バウンディングボックスとポリゴンの描画機能を実装

#### 2.1 ツールバー

- アノテーションツールバーコンポーネント
- ツール選択ボタン（選択、BBox、ポリゴン）
- カテゴリセレクタ

#### 2.2 BBox描画

- BBoxDrawer コンポーネント
- ドラッグによる矩形描画
- リアルタイムプレビュー
- 最小サイズ制約

#### 2.3 ポリゴン描画

- PolygonDrawer コンポーネント
- クリックによる頂点追加
- 閉じる操作（最初の頂点クリック、ダブルクリック、Enter）
- キャンセル操作（Escape）

#### 2.4 カテゴリ割り当て

- 描画完了時のカテゴリ自動割り当て
- カテゴリ選択UIとの連携

#### 2.5 アノテーション保存

- 作成したアノテーションのストア反映
- 履歴への記録（CREATE）
- プロジェクトの変更フラグ更新

---

### Phase 3: 選択・移動機能

**目標**: アノテーションの選択と移動機能を実装

#### 3.1 選択機能

- SelectionHandler コンポーネント
- 単一選択（クリック）
- 複数選択（Shift+クリック、Ctrl+クリック）
- 範囲選択（ドラッグ）
- 全選択（Ctrl+A）
- 選択解除（Escape、空白クリック）

#### 3.2 選択表示

- 選択中アノテーションのハイライト
- 選択ハンドルの表示

#### 3.3 移動機能

- ドラッグによる移動
- キーボードによる移動（矢印キー）
- 移動制約（Shift で水平/垂直）
- 複数選択時の一括移動

#### 3.4 履歴連携

- 移動操作の履歴記録（UPDATE）
- ドラッグ終了時に1つの履歴エントリ

---

### Phase 4: リサイズ・頂点編集

**目標**: BBoxのリサイズとポリゴンの頂点編集を実装

#### 4.1 BBoxリサイズ

- ResizeHandler コンポーネント
- 8方向のリサイズハンドル
- ドラッグによるリサイズ
- アスペクト比維持（Shift）
- 中心固定リサイズ（Alt）
- 最小サイズ制約

#### 4.2 ポリゴン頂点編集

- VertexEditor コンポーネント
- 頂点の表示
- 頂点のドラッグ移動
- 頂点の追加（辺の中点クリック）
- 頂点の削除（Delete、最小3頂点）

#### 4.3 カーソル制御

- 状態に応じたカーソル変更
- ハンドル上でのカーソル表示

#### 4.4 履歴連携

- リサイズ・頂点編集の履歴記録

---

### Phase 5: 削除・コピー＆ペースト

**目標**: 削除、コピー、ペースト機能を実装

#### 5.1 削除機能

- 単一・複数削除
- 削除確認ダイアログ（設定で無効化可能）
- キーボードショートカット（Delete、Backspace）

#### 5.2 コピー機能

- 選択アノテーションのコピー
- クリップボード管理
- キーボードショートカット（Ctrl+C）

#### 5.3 切り取り機能

- コピー後に削除
- キーボードショートカット（Ctrl+X）

#### 5.4 ペースト機能

- 同一画像へのペースト（オフセット配置）
- 別画像へのペースト（中央配置）
- 新しいIDの割り当て
- キーボードショートカット（Ctrl+V）

#### 5.5 複製機能

- 即座に複製
- キーボードショートカット（Ctrl+D）

#### 5.6 履歴連携

- 削除・ペーストの履歴記録
- バッチ操作のサポート

---

### Phase 6: Undo/Redo

**目標**: 完全なUndo/Redo機能を実装

#### 6.1 履歴管理強化

- 20世代の履歴管理
- 履歴エントリの説明文生成
- 履歴のクリア（プロジェクト変更時）

#### 6.2 Undo実装

- 各操作タイプの逆操作実装
- CREATE → DELETE
- DELETE → CREATE
- UPDATE → 以前の値に戻す
- BATCH → 逆順で各操作を元に戻す

#### 6.3 Redo実装

- futureリストの管理
- 操作の再実行

#### 6.4 UI連携

- Undo/Redoボタンの状態更新
- ツールチップに操作内容表示
- キーボードショートカット

---

### Phase 7: 保存・エクスポート

**目標**: 保存、自動保存、エクスポート機能を完成

#### 7.1 手動保存

- 保存ボタン
- キーボードショートカット（Ctrl+S）
- 保存完了通知

#### 7.2 自動保存

- 設定間隔での自動保存
- 変更検知
- バックグラウンド保存

#### 7.3 バックアップ

- 保存時のバックアップ作成
- バックアップ一覧表示
- バックアップからの復元
- 古いバックアップの自動削除

#### 7.4 エクスポート

- COCO形式エクスポートダイアログ
- フィルタオプション
- エクスポート先選択

#### 7.5 未保存警告

- 未保存時の終了警告
- 画像切り替え時の確認

---

### Phase 8: UI改善・仕上げ

**目標**: UI/UXの改善と仕上げ

#### 8.1 アノテーション一覧パネル

- サイドパネルにアノテーション一覧追加
- 選択・表示/非表示・削除操作
- ドラッグ＆ドロップで順序変更

#### 8.2 詳細パネル

- 選択アノテーションの詳細表示
- カテゴリ変更
- 座標・サイズ表示

#### 8.3 コンテキストメニュー

- 右クリックメニュー実装
- アノテーション上・空白上で異なるメニュー

#### 8.4 ステータスバー

- 画像位置、アノテーション数表示
- 保存状態インジケータ

#### 8.5 キーボードショートカット

- 全ショートカットの実装確認
- ショートカット設定UI
- ショートカットヘルプ表示

#### 8.6 レスポンシブ対応

- タブレット/モバイル対応
- ツールバー配置の調整

---

## テスト計画

### 単体テスト

- ストアのアクション
- ユーティリティ関数（座標計算、面積計算など）
- Rustコマンド

### 統合テスト

- プロジェクト作成→保存→読み込みフロー
- アノテーション作成→編集→保存フロー
- Undo/Redoの一貫性

### E2Eテスト

- 基本的なアノテーションワークフロー
- キーボードショートカット
- 自動保存

---

## 依存関係

### Phase間の依存

```
Phase 1 (基盤)
    ↓
Phase 2 (描画) ─────────────────┐
    ↓                          ↓
Phase 3 (選択・移動)      Phase 6 (Undo/Redo) ← 部分的に並行可能
    ↓                          ↓
Phase 4 (リサイズ・頂点)        │
    ↓                          │
Phase 5 (削除・コピー) ←────────┘
    ↓
Phase 7 (保存・エクスポート)
    ↓
Phase 8 (UI改善)
```

### 並行作業の可能性

- Phase 2 と Phase 6 の基盤部分は並行可能
- Phase 7 のバックエンド部分は Phase 2 完了後に着手可能
- Phase 8 のUI改善は各フェーズと並行して段階的に実施可能

---

## リスクと対策

### 技術的リスク

| リスク | 対策 |
|--------|------|
| Konva.jsでの複雑な描画処理 | 既存のAnnotationLayer実装を参考に |
| 大量アノテーション時のパフォーマンス | 既存のビューポートカリングを活用 |
| Undo/Redoの一貫性 | 操作ごとに十分なテスト |

### スケジュールリスク

| リスク | 対策 |
|--------|------|
| 想定以上の工数 | フェーズごとにスコープ調整可能な設計 |
| 要件の変更 | 早期にプロトタイプを作成してフィードバック収集 |

---

## 成果物

### Phase 1 完了時

- プロジェクト作成・読み込み・保存
- モード切り替え
- カテゴリ管理

### Phase 2 完了時

- BBox・ポリゴン描画（MVP）

### Phase 5 完了時

- 基本的な編集機能一式
- 実用可能なアノテーションツール

### Phase 8 完了時

- 完全なアノテーションエディタ機能
- プロダクションレディ
