# アノテーション編集機能 設計書

## 概要

バウンディングボックスとポリゴンの描画・編集機能を提供する。

## 描画ツール

### バウンディングボックス（BBox）

#### 描画方法

1. ツール選択（ツールバー or ショートカット `B`）
2. 開始点をクリック
3. ドラッグして矩形を描画
4. マウスを離して確定

#### 描画中の表示

- 描画中の矩形をリアルタイムプレビュー
- サイズ（幅 x 高さ）をツールチップで表示
- Shiftキー押下で正方形に制約

#### 最小サイズ

- 最小サイズ: 5x5ピクセル（設定で変更可能）
- 最小サイズ未満の場合は作成をキャンセル

### ポリゴン

#### 描画方法

1. ツール選択（ツールバー or ショートカット `P`）
2. 頂点をクリックして追加
3. 以下のいずれかで確定：
   - 最初の頂点付近をクリック（閉じる）
   - ダブルクリック
   - Enterキー
4. Escapeキーでキャンセル

#### 描画中の表示

- 確定済み頂点を点で表示
- 現在のマウス位置までの線をプレビュー
- 最初の頂点付近でハイライト（閉じる準備）
- 頂点数を表示

#### 頂点の制約

- 最小頂点数: 3
- Shiftキー押下で水平/垂直/45度に制約

## 編集機能

### 選択

#### 単一選択

- アノテーションをクリックで選択
- 選択中は青色のハイライト表示
- 選択ハンドル（リサイズ用）を表示

#### 複数選択

- Shift + クリックで追加選択
- Ctrl/Cmd + クリックで選択のトグル
- ドラッグで範囲選択（矩形選択）
- Ctrl/Cmd + A で全選択

#### 選択解除

- 何もない場所をクリック
- Escapeキー

### 移動

#### 単一移動

- 選択したアノテーションをドラッグ
- 移動中は半透明表示
- 移動量をツールチップで表示

#### 複数移動

- 複数選択状態でドラッグ
- すべての選択アノテーションが同時に移動

#### 移動の制約

- Shiftキー押下で水平/垂直に制約
- 画像境界外への移動は制限（設定で変更可能）

#### キーボード移動

- 矢印キーで1ピクセル移動
- Shift + 矢印キーで10ピクセル移動

### リサイズ（BBox）

#### リサイズハンドル

```
┌───────●───────┐
│               │
●               ●
│               │
└───────●───────┘
```

- 8つのハンドル（角4つ + 辺中央4つ）
- 角ハンドル: 自由リサイズ
- 辺ハンドル: 一方向のみリサイズ

#### リサイズの制約

- Shiftキー押下でアスペクト比を維持
- Altキー押下で中心を固定してリサイズ
- 最小サイズ制約

### 頂点編集（ポリゴン）

#### 頂点の選択

- ポリゴンを選択すると頂点が表示
- 頂点をクリックで個別選択

#### 頂点の移動

- 頂点をドラッグして移動
- Shiftキーで水平/垂直に制約

#### 頂点の追加

- 辺の中点にカーソルを合わせると追加ハンドルが表示
- クリックで新しい頂点を追加

#### 頂点の削除

- 頂点を選択してDeleteキー
- 最小頂点数（3）を下回る場合は削除不可
- 右クリックメニューからも削除可能

### 削除

#### 単一削除

- 選択してDeleteキー
- 右クリックメニュー → 削除

#### 複数削除

- 複数選択してDeleteキー
- 確認ダイアログ（設定で無効化可能）

### コピー＆ペースト

#### コピー

- Ctrl/Cmd + C で選択アノテーションをコピー
- 複数選択にも対応

#### ペースト

- Ctrl/Cmd + V でペースト
- 同じ画像: 元の位置から少しオフセット
- 別の画像: 中央に配置
- 新しいIDを自動割り当て

#### 切り取り

- Ctrl/Cmd + X で切り取り
- コピー後に削除

#### 複製

- Ctrl/Cmd + D で即座に複製
- オフセット位置に作成

## Undo/Redo

### 履歴管理

- 最大20世代の履歴を保持
- 履歴はプロジェクト単位で管理

### 対象操作

| 操作 | 説明 |
|------|------|
| アノテーション作成 | 新規作成を取り消し |
| アノテーション削除 | 削除を復元 |
| 移動 | 位置を復元 |
| リサイズ | サイズを復元 |
| 頂点編集 | 頂点位置を復元 |
| カテゴリ変更 | カテゴリを復元 |
| コピー＆ペースト | ペーストを取り消し |
| バッチ操作 | 複数操作を一括で取り消し |

### 操作方法

- Undo: Ctrl/Cmd + Z
- Redo: Ctrl/Cmd + Shift + Z または Ctrl/Cmd + Y

### 履歴表示

- ツールバーにUndo/Redoボタン
- ボタンのツールチップに次の操作内容を表示
- 履歴がない場合はボタンを無効化

## カテゴリ割り当て

### 新規作成時

- 選択中のカテゴリが自動で割り当て
- カテゴリセレクタで事前に選択

### カテゴリ変更

- アノテーションを選択
- カテゴリセレクタで変更
- または数字キー（1-9）でショートカット割り当て

### カテゴリのショートカット

- カテゴリにショートカットキーを設定可能
- アノテーション選択中にキーを押すとカテゴリ変更
- 描画中にキーを押すと使用カテゴリを変更

## キーボードショートカット

### ツール選択

| キー | 操作 |
|------|------|
| V | 選択ツール |
| B | BBoxツール |
| P | ポリゴンツール |

### 編集操作

| キー | 操作 |
|------|------|
| Delete / Backspace | 削除 |
| Ctrl/Cmd + C | コピー |
| Ctrl/Cmd + X | 切り取り |
| Ctrl/Cmd + V | ペースト |
| Ctrl/Cmd + D | 複製 |
| Ctrl/Cmd + A | 全選択 |
| Escape | 選択解除 / キャンセル |
| Enter | 確定（ポリゴン描画） |

### 履歴

| キー | 操作 |
|------|------|
| Ctrl/Cmd + Z | 元に戻す |
| Ctrl/Cmd + Shift + Z | やり直す |

### ナビゲーション

| キー | 操作 |
|------|------|
| ←/→ | 前/次の画像 |
| Home/End | 最初/最後の画像 |

### カスタマイズ

- 設定画面でショートカットのカスタマイズが可能
- 既存のビューモードのショートカットとの競合を回避

## コンテキストメニュー（右クリック）

### アノテーション上

- カテゴリを変更 →（サブメニュー）
- コピー
- 切り取り
- 削除
- 最前面へ
- 最背面へ
- プロパティ...

### 空白エリア

- ペースト（クリップボードにある場合）
- 全選択

## 描画順序

### Z-Order管理

- 後から作成したアノテーションが前面
- 最前面/最背面への移動機能
- ドラッグ＆ドロップで順序変更（アノテーション一覧）

## バリデーション

### 作成時

- 最小サイズチェック
- ポリゴンの自己交差チェック（警告のみ）
- 画像範囲外チェック

### 編集時

- 最小サイズ維持
- ポリゴンの最小頂点数維持

## パフォーマンス考慮

### 描画最適化

- 既存のビューポートカリングを活用
- 編集中のアノテーションのみ詳細なハンドル表示

### 履歴最適化

- 差分ベースの履歴保存
- 20世代を超えた履歴は自動破棄
